// Module included in the following assemblies:
//
// * observability/otel/otel-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="otel-troubleshooting-instrumentation-injection-into-your-workload_{context}"]
= Troubleshooting instrumentation injection into your workload

Troubleshooting instrumentation injection into your workload involves checking whether the `Instrumentation` object was created, the init-container started, the resources were deployed in the correct order, looking for errors in the operator logs, and double-checking the pod annotations.

.Procedure

. Run the following command to verify that the `Instrumentation` object was successfully created:
+
[source,console]
----
oc get instrumentation -n <workload_project> # <1>
----
<1> The namespace where the instrumentation is injected for workloads.

. Run the following command to verify that the `opentelemetry-auto-instrumentation` init-container successfully started, which is a prerequisite for instrumentation injection into workloads:
+
[source,console]
----
oc get events -n <workload_project> # <1>
----
<1> The namespace where the instrumentation is injected for workloads.
+
.Example output
[source,console]
----
... Created container opentelemetry-auto-instrumentation
... Started container opentelemetry-auto-instrumentation
----

. Verify that the resources were deployed in the correct order for the auto-instrumentation to work correctly. The correct order is to deploy the `Instrumentation` custom resource (CR) before the application. For information about the `Instrumentation` CR, see the section "Configuring the instrumentation".
+
[NOTE]
When the pod starts, the {OTELOperator} checks the `Instrumentation` CR for annotations containing instructions for injecting auto-instrumentation. Generally, the operator then adds an init-container to the applicationâ€™s pod that injects the auto-instrumentation and environment variables into the application's container. If the `Instrumentation` CR is not available to the operator when the application is deployed, the operator is unable to inject the auto-instrumentation.
+
Fixing the order of deployment requires the following steps:

.. Update the instrumentation settings.
.. Delete the instrumentation object.
.. Redeploy the application.

. Run the following command to inspect the operator logs for instrumentation errors:
+
[source,console]
----
oc logs -l app.kubernetes.io/name=opentelemetry-operator --container manager -n openshift-opentelemetry-operator --follow
----

. Troubleshoot pod annotations for the instrumentations for a specific programming language. See the required annotation fields and values in the section "Configuring the instrumentation".

.. Verify that the application pods that you are instrumenting are labeled with correct annotations and the appropriate auto-instrumentation settings have been applied.
+
For example: `instrumentation.opentelemetry.io/inject-python="true"`.
+
.Example command to get pod annotations for an instrumented Python application
[source,console]
----
oc get pods -n <workload_project> -o jsonpath='{range .items[?(@.metadata.annotations["instrumentation.opentelemetry.io/inject-python"]=="true")]}{.metadata.name}{"\n"}{end}'
----

.. Verify that the annotation applied to the instrumentation object is correct for the programming language that you are instrumenting.

.. If there are multiple instrumentations in the same namespace, specify the name of the `Instrumentation` object in their annotations.
+
For example: `instrumentation.opentelemetry.io/inject-nodejs: "<instrumentation_object>"`.

.. If the `Instrumentation` object is in a different namespace, specify the namespace in the annotation.
+
For example: `instrumentation.opentelemetry.io/inject-nodejs: "<other_namespace>/<instrumentation_object>"`.

.. Verify that the `OpenTelemetryCollector` custom resource contains the auto-instrumentation annotations under `spec.template.metadata.annotations` and not under `spec.metadata.annotations` where they have no effect. If you discover the auto-instrumentation annotations in `spec.metadata.annotations`, move them into `spec.template.metadata.annotations`.
