// Module included in the following assemblies:
//
// * distr_tracing_tempo/distr-tracing-tempo-configuring.adoc

:_content-type: REFERENCE
[id="distr-tracing-tempo-config-storage_{context}"]
= Distributed tracing storage configuration options

You configure storage for the Collector, Ingester, Distributor, and Query services under `spec.storage`. Multiple instances of each of these components can be provisioned as required for performance and resilience purposes.

.General storage parameters used by the {TempoOperator} to define distributed tracing storage

[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|spec:
  storage:
    type:
|Type of storage to use for the deployment.
|`memory` or `elasticsearch`.
Memory storage is only appropriate for development, testing, demonstrations, and proof of concept environments because the data does not persist when the pod is shut down. For production environments, the {TempoShortName} supports Elasticsearch for persistent storage.
|`memory`

|storage:
  secretname:
|Name of the secret, for example `tracing-secret`.
|
|N/A

|storage:
  options: {}
|Configuration options that define the storage.
|
|
|===

.Elasticsearch index cleaner parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|storage:
  esIndexCleaner:
    enabled:
|When using Elasticsearch storage, by default a job is created to clean old traces from the index. This parameter enables or disables the index cleaner job.
|`true`/ `false`
|`true`

|storage:
  esIndexCleaner:
    numberOfDays:
|Number of days to wait before deleting an index.
|Integer value
|`7`

|storage:
  esIndexCleaner:
    schedule:
|Defines the schedule for how often to clean the Elasticsearch index.
|Cron expression
|`"55 23 * * *"`
|===

[id="distributed-tracing-config-auto-provisioning-es_{context}"]
== Auto-provisioning an Elasticsearch instance

When you deploy a Tempo custom resource, the {TempoOperator} uses the OpenShift Elasticsearch Operator to create an Elasticsearch cluster based on the configuration provided in the `storage` section of the custom resource file. The {TempoOperator} provisions Elasticsearch if the following configurations are set:

* `spec.storage:type` is set to `elasticsearch`
* `spec.storage.elasticsearch.doNotProvision` is set to `false`
* `spec.storage.options.es.server-urls` is not defined, which means there is no connection to an Elasticsearch instance that was not provisioned by the Red Hat Elasticsearch Operator.

When provisioning Elasticsearch, the {TempoOperator} sets the Elasticsearch custom resource `name` to the value of `spec.storage.elasticsearch.name` from the Tempo custom resource.  If you do not specify a value for `spec.storage.elasticsearch.name`, the Operator uses `elasticsearch`.

[IMPORTANT]
====
* You can have only one {TempoShortName} with self-provisioned Elasticsearch instance per namespace. The Elasticsearch cluster is meant to be dedicated for a single {TempoShortName} instance.
* There can be only one Elasticsearch per namespace.
====

[NOTE]
====
If you have Elasticsearch installed as part of OpenShift Logging, the {TempoOperator} can use the installed OpenShift Elasticsearch Operator to provision storage.
====

The following configuration parameters are for a _self-provisioned_ Elasticsearch instance that is created by the {TempoOperator} by using the OpenShift Elasticsearch Operator. You specify configuration options for self-provisioned Elasticsearch under `spec:storage:elasticsearch` in your configuration file.

.Elasticsearch resource configuration parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|elasticsearch:
  properties:
    doNotProvision:
|Use this to specify whether or not an Elasticsearch instance must be provisioned by the {TempoOperator}.
|`true`/`false`
|`true`

|elasticsearch:
  properties:
    name:
|Name of the Elasticsearch instance. The {TempoOperator} uses the Elasticsearch instance specified in this parameter to connect to Elasticsearch.
|string
|`elasticsearch`

|elasticsearch:
  nodeCount:
|Number of Elasticsearch nodes. For high availability, use at least 3 nodes. Do not use 2 nodes to avoid the split-brain problem.
|Integer value. For example, Proof of concept = 1, Minimum deployment = 3
|3

|elasticsearch:
  resources:
    requests:
      cpu:
|Number of central processing units for requests, based on your environment's configuration.
|Specified in cores or millicores, for example, 200m, 0.5, or 1. For example, Proof of concept = 500m, Minimum deployment =1.
|1

|elasticsearch:
  resources:
    requests:
      memory:
|Available memory for requests, based on your environment's configuration.
|Specified in bytes, for example, 200Ki, 50Mi, 5Gi. For example, Proof of concept = 1Gi, Minimum deployment = 16Gi*
|16Gi

|elasticsearch:
  resources:
    limits:
      cpu:
|Limit on number of central processing units, based on your environment's configuration.
|Specified in cores or millicores, for example, 200m, 0.5, 1. For example, Proof of concept = 500m,
Minimum deployment =1
|

|elasticsearch:
  resources:
    limits:
      memory:
|Available memory limit based on your environment's configuration.
|Specified in bytes, for example, 200Ki, 50Mi, 5Gi. For example, Proof of concept = 1Gi,
Minimum deployment = 16Gi*
|

|elasticsearch:
  redundancyPolicy:
|Data replication policy defines how Elasticsearch shards are replicated across data nodes in the cluster. If not specified, the {TempoOperator} automatically determines the most appropriate replication based on number of nodes.
|`ZeroRedundancy`(no replica shards), `SingleRedundancy`(one replica shard), `MultipleRedundancy`(each index is spread over half of the Data nodes), `FullRedundancy` (each index is fully replicated on every Data node in the cluster).
|

|elasticsearch:
  useCertManagement:
|Use to specify whether or not the {TempoShortName} must use the certificate management feature of the Red Hat Elasticsearch Operator.  This feature was added to {logging-title} 5.2 in {product-title} 4.7 and is the preferred setting for new Tempo deployments.
|`true`/`false`
|`true`

|
3+|*Each Elasticsearch node can operate with a lower memory setting, but this must NOT be used for production deployments. For production use, you must have no less than 16Gi allocated to each pod by default and allocate as much as you can, up to 64Gi per pod.
|===

.Production storage
====
[source,yaml]
----
apiVersion: tempotracing.io/v1
kind: Tempo
metadata:
  name: simple-prod
spec:
  strategy: production
  storage:
    type: elasticsearch
    elasticsearch:
      nodeCount: 3
      resources:
        requests:
          cpu: 1
          memory: 16Gi
        limits:
          memory: 16Gi
----
====

.Storage with persistent storage
====
[source,yaml]
----
apiVersion: tempotracing.io/v1
kind: Tempo
metadata:
  name: simple-prod
spec:
  strategy: production
  storage:
    type: elasticsearch
    elasticsearch:
      nodeCount: 1
      storage: # <1>
        storageClassName: gp2
        size: 5Gi
      resources:
        requests:
          cpu: 200m
          memory: 4Gi
        limits:
          memory: 4Gi
      redundancyPolicy: ZeroRedundancy
----
<1> Persistent storage configuration. In this case, Amazon S3 `gp2` with `5Gi` size. When no value is specified, the {TempoShortName} uses `emptyDir`. The OpenShift Elasticsearch Operator provisions the `PersistentVolumeClaim` and `PersistentVolume` that will not be removed along with the TempoStack instance. You can mount the same volumes if you create a TempoStack instance with the same name and namespace.
====

[id="distributed-tracing-config-external-es_{context}"]
== Connecting to an existing Elasticsearch instance

You can use an existing Elasticsearch cluster for storage with the {DTShortName}. An existing Elasticsearch cluster, also known as an _external_ Elasticsearch instance, is an instance that was not installed by the {TempoOperator} or by the Red Hat Elasticsearch Operator.

When you deploy a Tempo custom resource, the {TempoOperator} does not provision Elasticsearch if the following configurations are set:

* `spec.storage.elasticsearch.doNotProvision` is set to `true`
* `spec.storage.options.es.server-urls` has a value
* `spec.storage.elasticsearch.name` has a value or the Elasticsearch instance name is `elasticsearch`

The {TempoOperator} uses the Elasticsearch instance specified in `spec.storage.elasticsearch.name` to connect to Elasticsearch.

[IMPORTANT]
====
You must not share or reuse a {product-title} logging Elasticsearch instance with the {TempoShortName}. The Elasticsearch cluster is meant to be dedicated for a single {TempoShortName} instance.
====

[NOTE]
====
Red Hat does not provide support for your external Elasticsearch instance. You can review the tested integrations matrix on the link:https://access.redhat.com/articles/5381021[Red Hat Customer Portal].
====

The following configuration parameters are for an already existing Elasticsearch instance, also known as an _external_ Elasticsearch instance. In this case, you specify configuration options for Elasticsearch under `spec:storage:options:es` in your custom resource file.

.General Elasticsearch configuration parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|es:
  server-urls:
|URL of the Elasticsearch instance.
|The fully-qualified domain name of the Elasticsearch server.
|`http://elasticsearch.<namespace>.svc:9200`

|es:
  max-doc-count:
|The maximum document count to return from an Elasticsearch query. This also applies to aggregations. If you set both `es.max-doc-count` and `es.max-num-spans`, Elasticsearch will use the smaller value of the two.
|
|10000

|es:
  max-num-spans:
|*Deprecated* and will be removed in a future release. Use `es.max-doc-count` instead. The maximum number of spans to fetch at a time, per query, in Elasticsearch. If you set both `es.max-num-spans` and `es.max-doc-count`, Elasticsearch will use the smaller value of the two.
|
|10000

|es:
  max-span-age:
|The maximum lookback for spans in Elasticsearch.
|
|72h0m0s

|es:
  sniffer:
|The sniffer configuration for Elasticsearch. The client uses the sniffing process to find all nodes automatically. Disabled by default.
|`true`/ `false`
|`false`

|es:
  sniffer-tls-enabled:
|The option to enable TLS when sniffing an Elasticsearch Cluster. The client uses the sniffing process to find all nodes automatically. Disabled by default.
|`true`/ `false`
|`false`

|es:
  timeout:
|The timeout used for queries. When set to zero, there is no timeout.
|
|0s

|es:
  username:
|The username required by Elasticsearch. The basic authentication also loads CA if it is specified. See also `es.password`.
|
|

|es:
  password:
|The password required by Elasticsearch. See also `es.username`.
|
|

|es:
  version:
|The major Elasticsearch version. If not specified, the value will be auto-detected from Elasticsearch.
|
|0
|===

.Elasticsearch data replication parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|es:
  num-replicas:
|The number of replicas per index in Elasticsearch.
|
|1

|es:
  num-shards:
|The number of shards per index in Elasticsearch.
|
|5
|===

.Elasticsearch index configuration parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|es:
  create-index-templates:
|When set to `true`, automatically creates index templates at application startup. When set to `false`, templates must be installed manually.
|`true`/ `false`
|`true`

|es:
  index-prefix:
|Optional prefix for {TempoShortName} indices. For example, when set to `"production"`, creates `"production-tracing-*"` indices.
|
|
|===

.Elasticsearch bulk processor configuration parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|es:
  bulk:
    actions:
|The number of requests that can be added to the queue before the bulk processor decides to commit updates to disk.
|
|1000

//What is the default here? The original text said "Set to zero to disable. By default, this is disabled."
|es:
  bulk:
    flush-interval:
|A `time.Duration` after which bulk requests are committed regardless of other thresholds. To disable the bulk processor flush interval, set this to zero.
|
|200ms

|es:
  bulk:
    size:
|The number of bytes that the bulk requests can take up before the bulk processor commits updates to disk.
|
|5000000

|es:
  bulk:
    workers:
|The number of workers that are able to receive and commit bulk requests to Elasticsearch.
|
|1
|===

.Elasticsearch TLS configuration parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|es:
  tls:
    ca:
|Path to a TLS Certification Authority (CA) file used to verify the remote servers.
|
|Uses the system truststore by default.

|es:
  tls:
    cert:
|Path to a TLS Certificate file, used to identify this process to the remote servers.
|
|

|es:
  tls:
    enabled:
|Enables transport layer security (TLS) when talking to the remote servers. Disabled by default.
|`true`/ `false`
|`false`

|es:
  tls:
    key:
|Path to a TLS Private Key file, used to identify this process to the remote servers.
|
|

|es:
  tls:
    server-name:
|Overrides the expected TLS server name in the certificate of the remote servers.
|
|
//Clarification of "if specified" for `token-file` and `username`, does that mean if this is set? Or that it only loads the CA if one is specified (that is, if es.tls.ca has a value?)
|es:
  token-file:
|Path to a file containing the bearer token. This flag also loads the Certification Authority (CA) file if it is specified.
|
|
|===

.Elasticsearch archive configuration parameters
[options="header"]
[cols="l, a, a, a"]
|===
|Parameter |Description |Values |Default value
|es-archive:
  bulk:
    actions:
|The number of requests that can be added to the queue before the bulk processor decides to commit updates to disk.
|
|0

//What is the default here? The original text said "Set to zero to disable. By default, this is disabled."
|es-archive:
  bulk:
    flush-interval:
|A `time.Duration` after which bulk requests are committed, regardless of other thresholds. To disable the bulk processor flush interval, set this to zero.
|
|0s

|es-archive:
  bulk:
    size:
|The number of bytes that the bulk requests can take up before the bulk processor decides to commit updates to disk.
|
|0

|es-archive:
  bulk:
    workers:
|The number of workers that are able to receive and commit bulk requests to Elasticsearch.
|
|0

|es-archive:
  create-index-templates:
|Automatically creates index templates at application startup when set to `true`. When set to `false`, templates must be installed manually.
|`true`/ `false`
|`false`

|es-archive:
  enabled:
|Enable extra storage.
|`true`/ `false`
|`false`

|es-archive:
  index-prefix:
|Optional prefix for {TempoShortName} indices. For example, when set to `"production"`, creates `"production-tracing-*"` indices.
|
|

|es-archive:
  max-doc-count:
|The maximum document count to return from an Elasticsearch query. This will also apply to aggregations.
|
|0

|es-archive:
  max-num-spans:
|*Deprecated* and will be removed in a future release. Use `es-archive.max-doc-count` instead. The maximum number of spans to fetch at a time, per query, in Elasticsearch.
|
|0

|es-archive:
  max-span-age:
|The maximum lookback for spans in Elasticsearch.
|
|0s

|es-archive:
  num-replicas:
|The number of replicas per index in Elasticsearch.
|
|0

|es-archive:
  num-shards:
|The number of shards per index in Elasticsearch.
|
|0

|es-archive:
  password:
|The password required by Elasticsearch. See also `es.username`.
|
|

|es-archive:
  server-urls:
|The comma-separated list of Elasticsearch servers. Must be specified as fully qualified URLs, for example, `\http://localhost:9200`.
|
|

|es-archive:
  sniffer:
|The sniffer configuration for Elasticsearch. The client uses the sniffing process to find all nodes automatically. Disabled by default.
|`true`/ `false`
|`false`

|es-archive:
  sniffer-tls-enabled:
|Option to enable TLS when sniffing an Elasticsearch Cluster. The client uses the sniffing process to find all nodes automatically. Disabled by default.
|`true`/ `false`
|`false`

|es-archive:
  timeout:
|Timeout used for queries. When set to zero, there is no timeout.
|
|0s

|es-archive:
  tls:
    ca:
|Path to a TLS Certification Authority (CA) file used to verify the remote servers.
|
|Will use the system truststore by default.

|es-archive:
  tls:
    cert:
|Path to a TLS Certificate file, used to identify this process to the remote servers.
|
|

|es-archive:
  tls:
    enabled:
|Enable transport layer security (TLS) when talking to the remote servers. Disabled by default.
|`true`/ `false`
|`false`

|es-archive:
  tls:
    key:
|Path to a TLS Private Key file, used to identify this process to the remote servers.
|
|

|es-archive:
  tls:
    server-name:
|Overrides the expected TLS server name in the certificate of the remote servers.
|
|

//Clarification of "if specified" for next two rows, does that mean if this is set? Or that it only loads the CA if one is specified (that is, if es-archive.tls.ca has a value?)
|es-archive:
  token-file:
|Path to a file containing the bearer token. This flag also loads the Certification Authority (CA) file if it is specified.
|
|

|es-archive:
  username:
|The username required by Elasticsearch. The basic authentication also loads CA if it is specified. See also `es-archive.password`.
|
|

|es-archive:
  version:
|The major Elasticsearch version. If not specified, the value is auto-detected from Elasticsearch.
|
|0
|===


.Storage with volume mounts
====
[source,yaml]
----
apiVersion: tempotracing.io/v1
kind: Tempo
metadata:
  name: simple-prod
spec:
  strategy: production
  storage:
    type: elasticsearch
    options:
      es:
        server-urls: https://quickstart-es-http.default.svc:9200
        index-prefix: my-prefix
        tls:
          ca: /es/certificates/ca.crt
    secretName: tracing-secret
  volumeMounts:
    - name: certificates
      mountPath: /es/certificates/
      readOnly: true
  volumes:
    - name: certificates
      secret:
        secretName: quickstart-es-http-certs-public
----
====

.External Elasticsearch
====
The following is a Tempo CR that uses an external Elasticsearch cluster with a TLS CA certificate mounted from a volume:
[source,yaml]
----
apiVersion: tempotracing.io/v1
kind: Tempo
metadata:
  name: simple-prod
spec:
  strategy: production
  storage:
    type: elasticsearch
    options:
      es:
        server-urls: https://quickstart-es-http.default.svc:9200 <1>
        index-prefix: my-prefix
        tls: <2>
          ca: /es/certificates/ca.crt
    secretName: tracing-secret <3>
  volumeMounts: <4>
    - name: certificates
      mountPath: /es/certificates/
      readOnly: true
  volumes:
    - name: certificates
      secret:
        secretName: quickstart-es-http-certs-public
----
<1> URL to Elasticsearch service running in default namespace.
<2> TLS configuration. In this example, there is only the CA certificate, but there can also be a `es.tls.key` and `es.tls.cert` when using mutual TLS.
<3> Secret which defines environment variables `ES_PASSWORD` and `ES_USERNAME` that has been created by running `$ kubectl create secret generic tracing-secret --from-literal=ES_PASSWORD=changeme --from-literal=ES_USERNAME=elastic`.
<4> Volume mounts and volumes which are mounted into all storage components.
====

[id="elasticsearch-for-certificate-management_{context}"]
= Elasticsearch for certificate management

You can use the Red Hat Elasticsearch Operator to create and manage certificates. You can use a single Elasticsearch cluster with multiple Tempo Collectors.

:FeatureName: Managing certificates with Elasticsearch
include::snippets/technology-preview.adoc[leveloffset=+1]

[IMPORTANT]
====
* The Elasticsearch node and the Tempo instances must be deployed in the same namespace, for example, `tracing-system`.
====

Starting with version 2.4, the {TempoOperator} delegates certificate creation to the Red Hat Elasticsearch Operator by using the following annotations in the Elasticsearch custom resource:

* `logging.openshift.io/elasticsearch-cert-management: "true"`
* `logging.openshift.io/elasticsearch-cert.tempo-<shared_elasticsearch_node_name>: "user.tempo"`
* `logging.openshift.io/elasticsearch-cert.curator-<shared_elasticsearch_node_name>: "system.logging.curator"`

.Elasticsearch CR with annotations
====
[source,yaml]
----
apiVersion: logging.openshift.io/v1
kind: Elasticsearch
metadata:
  annotations:
    logging.openshift.io/elasticsearch-cert-management: "true"
    logging.openshift.io/elasticsearch-cert.tempo-custom-es: "user.tempo"
    logging.openshift.io/elasticsearch-cert.curator-custom-es: "system.logging.curator"
  name: custom-es <1>
spec:
  managementState: Managed
  nodeSpec:
    resources:
      limits:
        memory: 16Gi
      requests:
        cpu: 1
        memory: 16Gi
  nodes:
    - nodeCount: 3
      proxyResources: {}
      resources: {}
      roles:
        - master
        - client
        - data
      storage: {}
  redundancyPolicy: ZeroRedundancy
----
<1> Name of the Elasticsearch node.
====

.TempoStack CR with `useCertManagement` set to `true`
====
[source,yaml]
----
apiVersion: tempotracing.io/v1
kind: Tempo
metadata:
  name: tempo-prod
spec:
  strategy: production
  storage:
    type: elasticsearch
    elasticsearch:
      name: custom-es
      doNotProvision: true
      useCertManagement: true <1>
----
<1> The `true` value enables certificate management.
====

The {TempoOperator} sets the Elasticsearch custom resource `name` to the value of `spec.storage.elasticsearch.name` from the Tempo custom resource when provisioning Elasticsearch.

The certificates are provisioned by the Red Hat Elasticsearch Operator and the {TempoOperator} injects the certificates.
