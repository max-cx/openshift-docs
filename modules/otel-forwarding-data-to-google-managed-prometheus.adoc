// Module included in the following assemblies:
//
// * forwarding/otel-forwarding-telemetry-data.adoc

:_mod-docs-content-type: CONCEPT
[id="otel-forwarding-data-to-google-managed-prometheus_{context}"]
= Forwarding telemetry data to Google-managed Prometheus

[role="_abstract"]
To forward metrics to Google-managed Prometheus, you need the OTLP Exporter, Metric Start Time Processor, and Google Client Authorization Extension.

[IMPORTANT]
====
The Google Client Authorization Extension is required for the OTLP Exporter to use the OpenShift secret authentication or Google Workload Identity Federation (WIF).
====

.OpenTelemetry Collector custom resource with the OTLP Exporter and Google WIF authentication
[source,yaml]
----
# ...
  mode: sidecar
  env:
    - name: GOOGLE_APPLICATION_CREDENTIALS <1>
      value: "/etc/workload-identity/credential-configuration.json"
  volumes:
    - name: workload-identity-credential-configuration
      configMap:
        name: gcp-wif-credentials <2>
    - name: service-account-token-volume
      projected:
	sources:
	- serviceAccountToken:
	    audience: openshift
	    expirationSeconds: 3600
	    path: token
  volumeMounts:
    - name: workload-identity-credential-configuration
      mountPath: "/etc/workload-identity"
      readOnly: true
    - name: service-account-token-volume
      mountPath: "/var/run/secrets/otel/serviceaccount" <3>
      readOnly: true
  config:
    extensions:
      googleclientauth: {}

    exporters:
      otlphttp:
        encoding: json
        endpoint: https://telemetry.googleapis.com
        auth:
          authenticator: googleclientauth

    processors:
      metricstarttime:
        strategy: subtract_initial_point <4>

      resource/gcp_project_id:
        attributes:
        - action: insert
          value: <project_id> <5>
          key: gcp.project_id

      k8sattributes: {}

      transform/collision:
        metric_statements:
        - context: datapoint
          statements:
          - set(attributes["exported_location"], attributes["location"])
          - delete_key(attributes, "location")
          - set(attributes["exported_cluster"], attributes["cluster"])
          - delete_key(attributes, "cluster")
          - set(attributes["exported_namespace"], attributes["namespace"])
          - delete_key(attributes, "namespace")
          - set(attributes["exported_job"], attributes["job"])
          - delete_key(attributes, "job")
          - set(attributes["exported_instance"], attributes["instance"])
          - delete_key(attributes, "instance")
          - set(attributes["exported_project_id"], attributes["project_id"])
          - delete_key(attributes, "project_id")

    service:
      extensions: [googleclientauth]
      pipelines:
        metrics:
          processors: [k8sattributes, resource/gcp_project_id, transform/collision, metricstarttime]
          exporters: [otlphttp]
# ...
----
<1> You can configure the environment variable `GOOGLE_APPLICATION_CREDENTIALS` to use an OpenShift secret or the Google Workload Identity Federation (WIF). This example uses the WIF.
<2> The config map contains the Google WIF configuration file `credential-configuration.json`.
<3> The path to the service account token used by the WIF.
<4> The `subtract_initial_point` strategy is stateful and requires the Collector to run as a sidecar to maintain the per-pod state. Alternative strategies are available, so choose the strategy that best fits your use case.
<5> The GCP project ID.
