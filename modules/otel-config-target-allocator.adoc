// Module included in the following assemblies:
//
// * otel/otel-configuring.adoc

:_mod-docs-content-type: REFERENCE
[id="otel-collector-ta-{context}"]
= OpenTelemetry Target Allocator

OpenTelemetry Target Allocator (TA) is an optional component which shards scrape targets across
deployed fleet of collectors and integrates with Prometheus `PodMonitor` and `ServiceMonitor` custom resources.
When the TA is enabled the OpenTelemetry Operator adds `http_sd_config` to the enabled `prometheus` receiver which
connects to the TA service.

.Example of the OpenTelemetry Collector custom resource with enabled Target allocator
[source,yaml]
----
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: observability
spec:
  mode: statefulset <1>
  targetAllocator:
    enabled: true <2>
    serviceAccount: <3>
    prometheusCR:
      enabled: true <4>
      scrapeInterval: 10s
      serviceMonitorSelector: <5>
        name: app1
      podMonitorSelector: <6>
        name: app2
  config: |
    receivers:
      prometheus: <7>
        config:
          scrape_configs: []
    processors:
    exporters:
      debug:
    service:
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: []
          exporters: [debug]
----
<1> The deployment mode has to be set to `statefulset` when TA is enabled.
<2> Enable TA. Defaults to `false`.
<3> Service account name of the TA deployment. The service account needs to have RBAC to get `ServiceMonitor`, `PodMonitor` custom resources and other objects from the cluster to properly set labels on scraped metrics. The default service name is `<collector-name>-targetallocator`.
<4> Enable integration with Prometheus `PodMonitor` and `ServiceMonitor` custom resources.
<5> Label selector for Prometheus `ServiceMonitor` custom resources. When empty all service monitors are enabled.
<6> Label selector for Prometheus `PodMonitor` custom resources. When empty all pod monitors are enabled.
<7> Prometheus receiver with at least empty `scrape_config: []` configuration option.

The Target Allocator deployment uses Kubernetes API to get relevant objects from the cluster, therefore it needs a custom RBAC configuration.

.RBAC configuration for the Target Allocator service account.
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-targetallocator
rules:
  - apiGroups: [""]
    resources:
      - services
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: ["monitoring.coreos.com"]
    resources:
      - servicemonitors
      - podmonitors
    verbs: ["get", "list", "watch"]
  - apiGroups: ["discovery.k8s.io"]
    resources:
      - endpointslices
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-targetallocator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-targetallocator
subjects:
  - kind: ServiceAccount
    name: otel-targetallocator <1>
    namespace: observability <2>
----
<1> Name of the TA service mane.
<2> The namespace of the TA service account.
